## _Тестирование API: что именно нужно тестировать?_

***Полезные ссылки:***
- **[Youtube Леша Маршал](https://www.youtube.com/watch?v=RwuOzGJJcQ0)**
- **[Youtube Артем Русов](https://www.youtube.com/watch?v=kUPWQMalWNk)**
- **[Habr. Testing API](https://habr.com/ru/post/568360/)**
- **[Habr. What is API](https://habr.com/ru/post/464261/)**
- **[Postman documentation](https://learning.postman.com/docs/getting-started/introduction/)**

### ***Что это вообще такое?***

***API*** — это ***Application Programming Interface***, или программный интерфейс приложения, с помощью которого одна программа может взаимодействовать с другой. ***API*** позволяет слать информацию напрямую из одной программы в другую, минуя интерфейс взаимодействия с пользователем. 

***Как это работает?*** Представьте, что вы сидите в ресторане, выбираете блюдо в меню. Подходит официант, и вы делаете заказ. Официант передаёт ваш заказ на кухню, там происходит магия, и через некоторое время перед вами появляется готовое блюдо. ***API*** работает по такому же принципу — принимает ваш запрос, передаёт информацию системе, обрабатывает её и возвращает ответ. 

***Какие бывают?*** ***API*** может быть внутренним, частным — когда программные компоненты связаны между собой и используются внутри системы. А может быть открытым, публичным — в таком случае он позволяет внешним пользователям или другим программам получать информацию, которую можно интегрировать в свои приложения.

Чтобы программам общаться между собой, их ***API*** нужно построить по единому стандарту. Одним из них является ***REST*** — стандарт архитектуры взаимодействия приложений и сайтов, использующий протокол ***HTTP***. Особенность ***REST*** в том, что сервер не запоминает состояние пользователя между запросами. Иными словами, идентификация пользователя (авторизационный токен) и все параметры выполнения операции передаются в каждом запросе. Этот подход настолько прост и удобен, что почти вытеснил все другие.

### ***Стратегия тестирования API***
***Стратегия тестирования*** - это высокоуровневое описание требований к тестированию, из которого впоследствии может быть составлен подробный план тестирования с указанием отдельных тестовых сценариев и тестовых случаев. Наша первая задача - это функциональное тестирование, чтобы убедиться, что ***API*** работает правильно.

Основными задачами функционального тестирования ***API*** являются: 
- убедиться, что реализация ***API*** работает правильно, как и ожидалось - без ошибок;
- гарантировать, что реализация ***API*** работает в соответствии со спецификацией требований (которая позже становится нашей документацией по ***API***);
- предотвратить регрессий между написанным кодом(merge) и релизом.

### ***API как соглашение - сначала проверьте спецификацию!***
***API*** - это, по сути, соглашение между клиентом и сервером или между двумя приложениями. Перед тем, как начать любое тестирование функциональности, важно убедиться в правильности соглашения. Это можно сделать сначала проверив спецификацию (или само соглашение службы, например, интерфейс ***Swagger*** или ссылку ***OpenAPI***) и убедившись, что:
- эндпоинты правильно именованы; 
- ресурсы и их типы правильно отражают объектную модель;
- нет отсутствующей или дублирующей функциональности; 
- отношения между ресурсами правильно отражаются в ***API***.

### ***Этапы тестирования API***
Каждый тест состоит из тестовых шагов. Это отдельные атомарные действия, которые тест должен выполнять в каждом потоке тестирования ***API***. Для каждого запроса ***API*** тест должен будет выполнить следующие действия:
- проверьте корректность кода состояния ***HTTP***. Например, создание ресурса должно возвращать ***201 CREATED***, а запрещенные запросы должны возвращать ***403 FORBIDDEN*** и т.д.
- проверьте полезную нагрузку ответа. Проверьте правильность тела ***JSON***, имен, типов и значений полей ответа, в том числе в ответах на ошибочные запросы.
- проверьте заголовки ответа. Заголовки ***HTTP***-сервера влияют как на безопасность, так и на производительность.
- проверьте правильность состояния приложения. Это необязательно и применяется в основном к ручному тестированию или когда пользовательский интерфейс или другой интерфейс можно легко проверить. 
- проверьте базовую работоспособность. Если операция была завершена успешно, но заняла неоправданно много времени, тест не пройден.

### ***Категории тестовых сценариев***
Наши тест-кейсы делятся на следующие общие группы тестовых сценариев:
- основные позитивные тесты (прохождение успешного сценария по умолчанию);
- расширенное позитивное тестирование с дополнительными параметрами;
- негативное тестирование с валидными входными данными;
- негативное тестирование с недопустимыми входными данными;
- деструктивное тестирование;
- тесты безопасности, авторизации и доступности (которые выходят за рамки этой статьи).

***Тестирование успешного сценария по умолчанию*** проверяет базовую функциональность и критерии приемки ***API***. Позже мы расширим положительные тесты, чтобы включить дополнительные параметры и дополнительные функции. 

Следующая группа тестов - это ***негативное тестирование***, при котором мы ожидаем, что приложение будет корректно обрабатывать проблемные сценарии как с валидным вводом пользователя (например, попытка добавить существующее имя пользователя), так и с недопустимым вводом пользователя (попытка добавить имя пользователя, которое имеет значение ***null***). 

***Деструктивное тестирование*** - это более глубокая форма негативного тестирования, когда мы намеренно пытаемся сломать ***API***, чтобы проверить его надежность (например, отправляя заведомо большое тело запроса в попытке переполнить систему).

### ***Пример API и тестовая матрица***
Теперь мы можем отобразить все в виде матрицы и использовать ее для написания подробного плана тестирования (для автоматизации тестирования или ручных тестов).

Предположим, что подмножеством нашего ***API*** является конечная точка ***/users***, которая включает следующие вызовы ***API***:

| ***Вызов API*** | ***Действие*** |
| ------ | ------ |
|***GET*** /users| Просмотреть всех пользователей                                                   |
|***GET*** /users?name={username}| Получить пользователя по имени пользователя                      |
|***GET*** /users/{id}| Получить пользователя по ID                                                 |
|***GET*** /users/{id}/configurations| Получите все конфигурации для пользователя                   |
|***POST*** /users/{id}/configurations| Создать новую конфигурацию для пользователя                 |
|***DELETE*** /users/{id}/configurations/{id}| Удалить конфигурацию для пользователя                |
|***PATCH*** /users/{id}/configuration/{id}| Обновить конфигурацию для пользователя                 |

> Где ***{id}*** - это UUID, а все конечные точки ***GET*** позволяют фильтровать, сортировать, исключать и ограничивать дополнительные параметры запроса для фильтрации, сортировки и разбивки на страницы тела ответа.

### ***Выходим за рамки функционального тестирования***
##### ***Безопасность и авторизация***
- ***Убедитесь***, что ***API*** разработан в соответствии с правильными принципами безопасности: отказ по умолчанию, безопасное падение сервиса, принцип наименьших привилегий, отклонение всех невалидных данных в запросе и т. д.
- ***Позитивные тесты***: убедитесь, что ***API*** отвечает на правильную авторизацию всеми согласованными методами аутентификации - ответный токен ***auth 2.0***, файлы cookie, дайджест и т. д. - как определено в вашей спецификации.
- ***Негативные тесты***: убедитесь, что ***API*** отклоняет все несанкционированные вызовы.
- ***Ролевые доступы***: убедитесь, что определенные конечные точки доступны пользователю в зависимости от роли. ***API*** должен отклонять вызовы конечных точек, которые не разрешены для роли пользователя.
- ***Проверка протокола***: проверьте ***HTTP / HTTPS*** в соответствии со спецификацией
- ***Утечки данных***: убедитесь, что представления внутренних данных, которые должны оставаться внутри компании, не просачиваются за пределы общедоступного ***API*** в данных ответа.
- ***Политики*** ограничения скорости, троттлинга и политики контроля доступа

##### ***Производительность***
- Проверка времени ответа ***API***, задержки, ***TTFB / TTLB*** в различных сценариях (изолированно и под нагрузкой)

##### ***Нагрузочные тесты (позитивные), стресс-тесты (негативные)***
- Найдите точки ограничения производительности и убедитесь, что система работает должным образом под нагрузкой и корректно выходит из строя под нагрузкой. 

##### ***Юзабилити-тесты пользователей API***
- Для общедоступных ***API***: ручной тест на уровне продукта, который проверяет  весь путь разработчика от документации, входа в систему, аутентификации, примеров кода и т. д., Чтобы гарантировать удобство использования ***API*** для пользователей, не знакомых с вашей системой.





